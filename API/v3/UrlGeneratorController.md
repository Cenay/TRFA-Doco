# UrlGeneratorController
The purpose of the URL generator is to allow a user to click a link in an email, and redirect them to the correct page, with all the parameters passed so the form completes with their prior information. The endpoint is called from ActiveCampaign, with the ID of the contact (user) and the base URL to generate for.  

>Sample Usage:  
https://trfaapi.com/v3/util/url/kids-party/{1335} 
Where {1335} is the contact id within ActiveCampaign 

This is called when contact clicks the link in email within ActiveCampaign.  

**Parameters**
 * {class} -> Possible values: "Kids Party", "Adults Party", "Field Trips"
 * {id} -> Contact ID from ActiveCampaign (passed as %SUBSCRIBERID%)
 * {redirect?} _[Optional]_ -> 
 
 https://trfaapi.com/v3/util/url/adults-party/1048/

1. Is the base URI that ActiveCampaign passes. If it fails, the function calls #3. 
2. The redirect link posted to the view so that contact can find the correct link in the event the "link" fails. (See image below)
3. Old method, no longer used in current emails, left in for backwards compatibility, so that the link in the old emails does not break.  

There are three routes for generating URLs.
```
  1. Route::get('/url/{class}/{id}', 'UrlGeneratorController@ajaxRedirectToUrl');
  2. Route::get('/party/{class}/{id}/{redirect?}', 'UrlGeneratorController@index')->name('urlGenerator');;
  3. Route::get('/{class}/{id}/{redirect?}', 'UrlGeneratorController@index')->name('urlOldGenerator');
```
_Showing the #2 Link reason_
![URL Generator](/img/url-generator-explain-second-route.jpg)


# Methods
Functions used by the URL Generator class.

## ajaxRedirectToUrl
A simple method that just returns url generator view (v3/resources/views/ajax-url-generator.blade.php) where we display the loader until redirected to the correct url. Will also provide a link to the correct URL in the event the program hangs.  
>**RETURNS** view(ajax-url-generator)

## index
A traffic cop that directs to the correct method based on the passed parameter. It takes 3 arguments. 
 * $class: Possible values are "kids-party", "adults-party", and "field-trips". Based on the class name it will redirect to the method responsible to generating url for that class. For example in class of kids class flow will be redirected to `constructKidsPartyUrl` method.
 * $contactId: The ActiveCampaign subscriber ID passed to the base endpoint in the API
 * $redirect (default = null): Internal use only. Used to determine if ajax view is used. 
 >**RETURNS** Nothing

## constructKidsPartyUrl
This method takes two arguments `$contactId, $redirect`.
`$contactId` is the active campaigns contact id and `$redirect` is a boolean. When it is true it will redirect the user directly to redirects url. (This was the intial approach that we implemented first and later we added a loader view because generating a url and then redirecting to it was taking some with and we wanted to give use some feedback).
This method fetchs the details from acitve campaign by calling another method `$details = $this->getContactDetailsFromActiveCampaign($contactId, 60);`
We've passed 60 as second parameter, and 60 is id of **Kids party info 1** in active campaign.

####getContactDetailsFromActiveCampaign
getContactDetailsFromActiveCampaign method takes two arguments
Active Campaign Contact Id &Active Campaign Info Field's Id.
this method will return array containing contact information and kids party info 1 value. 
If **kids party info 1** field is empty then we just redirect to base url with contact information only. i.e, name, email, phone etc.
If there is a value then we explode the information by PHP_EOL. From the first line of **kids party info 1** we extract the package name. We extract the package name becase that will tell us what should be the redirect url because in case of kids parties we have 3 forms i.e top, budding and executive. 
We then build query sending by the information in **kids party info 1** by calling `buildQueryString` method. 

####buildQueryString
Build query string uses a built in PHP method "http_build_query" to build a query stirng from the array passed. 
The array is generated by calling a method `searchArrayValue` against each key
If location is set of "my location" then we make a call to another mthod which will get us the locaiton value address, city, state, zip.

####buildQueryStringForAdultsParty
Just like the above method this detals with adult parties

####buildQueryStringForFieldTrips
This method is almost same like buildQueryString but it will generate the query string for field trips.

####searchArrayValue
This method takes 3 parameters `$hayStack, $needle, $index` i.e.
`'entree' => $this->searchArrayValue($kidsPartyInfoField, 'Entree', 1)`
In this example it will look for keyword *entree* and then split that line by **':'** and takes party depending upon index. 

####getLocationDetails
If in party details location is set to "my location" then we need location values like address, city, state and zip
Following are the active campaign id's for each field we need. 
34: Address 1, 36: City , 37: State ,38: Zip
This method will query active campaign get the data in these fields and return back the array



